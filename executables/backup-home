#!/bin/bash

# Configurations
USB_UUID="<your-usb-uuid>"
MOUNT_POINT="/mnt/backup"
SOURCE_DIRS="/home /etc /var"  # Directories to back up
BACKUP_DIR="$MOUNT_POINT/backups"
LOG_FILE="$MOUNT_POINT/backup.log"
EXCLUDES="/path/to/exclude-file"  # Optional

# Check if the USB is connected
if ! lsblk -o UUID | grep -q "$USB_UUID"; then
    echo "USB drive not connected!" >> /var/log/backup-errors.log
    exit 1
fi

# Mount the USB if not already mounted
if ! mountpoint -q "$MOUNT_POINT"; then
    sudo mount UUID="$USB_UUID" "$MOUNT_POINT"
    if [ $? -ne 0 ]; then
        echo "Failed to mount the USB drive!" >> /var/log/backup-errors.log
        exit 1
    fi
fi

# Ensure the backup directory exists
mkdir -p "$BACKUP_DIR"

# Perform the backup
rsync -av --delete --exclude-from="$EXCLUDES" $SOURCE_DIRS "$BACKUP_DIR" >> "$LOG_FILE" 2>&1

# Sync to ensure all data is written
sync

echo "Backup completed on $(date)" >> "$LOG_FILE"
